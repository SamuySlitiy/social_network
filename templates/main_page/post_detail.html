{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Post Details</h1>
    <ul>

        <h2>{{ post.content }}</h2>
        {% if post.image %}
            <img src="{{ post.image.url }}" alt="Post image">
        {% endif %}
        <p>Created at: {{ post.created_at }}</p>

        <p><a href="{% url 'like-list' post.id %}">Likes:</a> 
            <ul>
                {% for like in likes %}
                    <li>{{ like.user.username }}</li>
                {% endfor %}
            </ul><span id="likes-count">{{ post.likes.count }}</span>
        </p>

        <button id="like-btn" data-post-id="{{ post.id }}">
            {% if user in post.likes.all %}
                Unlike
            {% else %}
                Like
            {% endif %}
        </button>

        <h2>Comments:</h2>
        {% if comments %}
            <li>
                <a href="{% url 'comment-list' post.id %}"> View Comments</a>
                <h1>Comments for this Post:</h1>
                <ul>
                    {% for comment in comments %}
                        <li>
                            <strong>{{ comment.author.username }}</strong>: {{ comment.content }}
                            <br>
                            <small>Sent at: {{ comment.created_at }}</small>
                            {% if user == comment.author %}

                                <a href="{% url 'comment-edit' post.id comment.id %}">Edit</a>
                                <h1>Edit Your Comment:</h1>
                                <form method="post">
                                    {% csrf_token %}
                                    {{ form.as_p }}
                                    <button type="submit">Confirm</button>
                                </form> 
                                
                                <a href="{% url 'comment-delete' post.id comment.id %}">Delete</a>
                                <form method="post">
                                    {% csrf_token %}
                                    <button type="submit">Delete Comment</button>
                                </form>

                            {% endif %}
                        </li>
                        <br>
                    {% endfor %}

                    <a href="{% url 'comment-create' post.id %}">Create a Comment</a>
                    <h1>Your Comment:</h1>
                    <form method="post" action="">
                        {% csrf_token %}
                        {{ form.as_p }}
                        <button type="submit">Send</button>
                    </form>
                    
                </ul>
            </li>
        {% else %}
            <li>
                <p>No comments for this post.</p>
                <a href="{% url 'comment-create' post.id %}">Create a Comment</a>
            </li>
        {% endif %}

    </ul>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script>
    $(document).ready(function() {
        $("#like-btn").click(function() {
            let postId = $(this).data("post-id");
            let isLiked = $(this).text() === "Unlike";

            let url = isLiked
                ? "{% url 'like-delete' post.id %}"
                : "{% url 'like-create' post.id %}";

            $.ajax({
                url: url,
                type: "POST",
                data: {
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                success: function(response) {
                    $("#likes-count").text(response.likes_count);
                    $("#like-btn").text(isLiked ? "Like" : "Unlike");
                },
                error: function(xhr) {
                    console.log(xhr.responseText);
                }
            });
        });
    });
</script>
</html>
