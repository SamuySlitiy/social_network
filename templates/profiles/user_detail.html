{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>{{ user.username }} - Profile</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <button class="btn btn-secondary mt-3" onclick="history.back()">Go Back</button>
<div class="container">
    <h1>{{ user.username }}</h1>
    <ul>
        <br>
        {% if user.profile_picture %}
            <img src="{{ user.profile_picture.url }}" alt="Profile Picture" width="100" height="100" style="border-radius: 45%;">
        {% endif %}
        <br>
        <br>
        <strong>First Name:</strong> {{ user.first_name }} 
        <br>
        <strong>Last Name:</strong> {{ user.last_name }} 
        <br>
        <small>Email:</small> <strong>{{ user.email }}</strong>
        <br>
        <strong>Bio:</strong> {{ user.bio }}
        <br>
        <br>

        {% if user == request.user %}
            <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#updateProfileModal">
                Update Profile
            </button>
        {% endif %}


        <button class="btn btn-primary" id="follow-btn" data-user-id="{{ user.id }}">
            {% if request.user in user.followers.all %}
                Unfollow
            {% else %}
                Follow
            {% endif %}
        </button>

        <button class="btn btn-primary" data-toggle="modal" data-target="#followersModal">
            View Followers
        </button>
        
    </ul>
</div>

        <div class="modal fade" id="updateProfileModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Update Profile</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="updateProfileForm" enctype="multipart/form-data">
                            {% csrf_token %}

                            <div class="mb-4">
                                <label for="first_name" class="form-label"><strong>First Name:</strong></label>
                                <input type="text" class="form-control" id="first_name" name="first_name" value="{{ user.first_name }}">
                            </div>

                            <div class="mb-4">
                                <label for="last_name" class="form-label"><strong>Last Name:</strong></label>
                                <input type="text" class="form-control" id="last_name" name="last_name" value="{{ user.last_name }}">
                            </div>

                            <div class="mb-4">
                                <label for="bio" class="form-label"><strong>Bio:</strong></label>
                                <textarea class="form-control" id="bio" name="bio">{{ user.bio }}</textarea>
                            </div>

                            <div class="mb-4">
                                <label for="email" class="form-label"><strong>Email</strong></label>
                                <input type="text" class="form-control" id="email" name="email"><small>Before: </small>{{ user.email }}</input>
                            </div>

                            <div class="mb-4">
                                <label for="profile_picture" class="form-label"><strong>Profile Picture</strong></label>
                                <input type="file" class="form-control" id="profile_picture" name="profile_picture">
                            </div>

                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>

        
            <div class="modal fade" id="followersModal" tabindex="-1" role="dialog" aria-labelledby="followersModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="followersModalLabel">{{ user.username }}'s Followers</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <ul>
                                {% for follow in follows %}
                                    {% if follow.is_followed == user %}
                                        <li>{{ follow.is_following.username }} follows {{ follow.is_followed.username }}</li>
                                    {% else %}
                                        <li>{{ follow.is_followed.username }} follows {{ follow.is_following.username }}</li>
                                    {% endif %}
                                {% empty %}
                                    <li>No followers yet!</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
  
</div>

<script>
    $(document).ready(function () {
        $("#updateProfileForm").submit(function (event) {
            event.preventDefault();
            let formData = new FormData(this);

            $.ajax({
                url: "{% url 'user-update' user.id %}",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    alert("Profile updated successfully!");
                    location.reload();
                },
                error: function (xhr) {
                    alert("Error updating profile!");
                }
            });
        });
    });
</script>
<script>
    $(document).ready(function () {
        $("#follow-btn").click(function () {
            var button = $(this);
            var userId = button.data("user-id");  // Get user ID from button attribute

            $.ajax({
                url: "{% url 'follow-toggle' %}",  // Ensure this URL is correct in urls.py
                type: "POST",
                data: {
                    user_id: userId,  // Send user ID in the request
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                success: function (response) {
                    if (response.followed) {
                        button.text("Unfollow").removeClass("btn-primary").addClass("btn-danger");
                        alert("Following this user!");
                    } else {
                        button.text("Follow").removeClass("btn-danger").addClass("btn-primary");
                        alert("Now not following this user.");
                    }
                },
                error: function () {
                    alert("Error toggling follow status. You cant follow yourself!");
                }
            });
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</body>
</html>
